<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ | √ÜSLAN</title>
  <style>
    body {
      background-color: #808080;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
    }

    .form-container {
      background: white;
      padding: 20px;
      margin: 20px auto;
      width: 400px;
      border-radius: 10px;
      border: 4px solid black;
    }

    h2 {
      margin-bottom: 10px;
    }

    input, button {
      width: 90%;
      padding: 12px;
      margin: 10px 0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .button {
      background: black;
      color: white;
      cursor: pointer;
    }

    .button:hover {
      background: #333;
    }

    #qrcode {
      margin-top: 10px;
      display: inline-block;
    }
  </style>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/8.0.3/otpauth.umd.min.js"></script>
</head>
<body>

  <!-- üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
  <div class="form-container">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input type="text" id="newUsername" placeholder="–ù–æ–≤—ã–π –ª–æ–≥–∏–Ω">
    <input type="password" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
    <button onclick="registerUser()" class="button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  </div>

  <!-- üîê OTP-–∫–æ–¥ -->
  <div class="form-container" id="otp-section" style="display: none;">
    <h2>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥</h2>
    <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏ –≤–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ Google Authenticator:</p>
    <div id="qrcode"></div>
    <input type="text" id="otpCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ OTP">
    <button onclick="verifyOtp()" class="button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω–æ: QR –∏ TOTP
    let secret, totp;
    let currentUser = null;

    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function getUsers() {
      return JSON.parse(localStorage.getItem("users")) || [];
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function saveUsers(users) {
      localStorage.setItem("users", JSON.stringify(users));
    }

    // üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    function registerUser() {
      const username = document.getElementById("newUsername").value.trim();
      const password = document.getElementById("newPassword").value;

      if (!username || !password) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
        return;
      }

      let users = getUsers();

      if (users.some(u => u.username === username)) {
        alert("–¢–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
        return;
      }

      users.push({ username, password });
      saveUsers(users);
      currentUser = username;

      // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤–≤–æ–¥—É OTP
      document.querySelector('.form-container').style.display = 'none';
      document.getElementById('otp-section').style.display = 'block';

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è OTP –∏ QR-–∫–æ–¥–∞
      secret = new OTPAuth.Secret({ size: 20 });
      totp = new OTPAuth.TOTP({
        issuer: "√ÜSLAN",
        label: username,
        algorithm: "SHA1",
        digits: 6,
        period: 30,
        secret: secret
      });

      const otpUrl = totp.toString();

      new QRCode(document.getElementById("qrcode"), {
        text: otpUrl,
        width: 150,
        height: 150
      });
    }

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ OTP
    function verifyOtp() {
      const otpInput = document.getElementById("otpCode").value.trim();
      const valid = totp.validate({ token: otpInput, window: 1 }) !== null;

      if (valid) {
        alert("–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!");
        localStorage.setItem("user", currentUser);
        window.location.href = "index.html";
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
      }
    }
  </script>

</body>
</html>
